<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KINAFLIX TV - Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#e50914">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js"></script>
</head>
<body>
    <div class="admin-container">
        <!-- Header -->
        <div class="admin-header">
            <div class="logo">
                <i class="fas fa-tv"></i>
                <span>KINAFLIX TV - Admin Panel</span>
            </div>
            <div class="admin-nav">
                <a href="index.html" class="btn btn-secondary btn-small">
                    <i class="fas fa-home"></i> Home
                </a>
                <a href="view.html" class="btn btn-primary btn-small">
                    <i class="fas fa-play"></i> View Stream
                </a>
            </div>
        </div>

        <!-- Stats Dashboard -->
        <div class="stats-dashboard">
            <h2><i class="fas fa-chart-line"></i> Live Dashboard</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <i class="fas fa-eye" style="font-size: 24px; color: var(--primary);"></i>
                    <div class="stat-value" id="viewerCount">0</div>
                    <div class="stat-label">Active Viewers</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-film" style="font-size: 24px; color: var(--primary);"></i>
                    <div class="stat-value" id="videoCount">0</div>
                    <div class="stat-label">Videos in Playlist</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-clock" style="font-size: 24px; color: var(--primary);"></i>
                    <div class="stat-value" id="streamTime">24/7</div>
                    <div class="stat-label">Stream Status</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-signal" style="font-size: 24px; color: var(--primary);"></i>
                    <div class="stat-value" id="streamStatus">ONLINE</div>
                    <div class="stat-label">Stream Status</div>
                </div>
            </div>
        </div>

        <!-- Video Management -->
        <div class="admin-section">
            <h2><i class="fas fa-video"></i> Video Management</h2>
            
            <!-- Add Video Form -->
            <div class="form-card">
                <h3>Add New Video</h3>
                <div class="form-group">
                    <label for="videoName">Video Name *</label>
                    <input type="text" id="videoName" placeholder="Enter video title" required>
                </div>
                <div class="form-group">
                    <label for="videoUrl">Video URL *</label>
                    <input type="url" id="videoUrl" 
                           placeholder="https://your-cdn.com/video.mp4" 
                           required>
                    <small class="form-help">Supports: MP4, WebM, OGG, MOV, AVI, MKV from Bunny CDN or any direct URL</small>
                </div>
                <div class="form-group">
                    <label for="videoOrder">Play Order</label>
                    <select id="videoOrder">
                        <option value="append">Add to End</option>
                        <option value="prepend">Add to Beginning</option>
                        <option value="now">Play Now</option>
                    </select>
                </div>
                <button class="btn btn-primary" id="addVideoBtn">
                    <i class="fas fa-plus"></i> Add Video
                </button>
            </div>

            <!-- Videos List -->
            <div class="videos-list">
                <h3>Playlist Videos</h3>
                <div id="videosContainer" class="videos-container">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i> Loading videos...
                    </div>
                </div>
            </div>
        </div>

        <!-- System Controls -->
        <div class="admin-section">
            <h2><i class="fas fa-cogs"></i> System Controls</h2>
            <div class="controls-grid">
                <button class="btn btn-secondary" id="refreshBtn">
                    <i class="fas fa-sync"></i> Refresh Playlist
                </button>
                <button class="btn btn-secondary" id="clearChatBtn">
                    <i class="fas fa-trash"></i> Clear Chat History
                </button>
                <button class="btn btn-danger" id="resetStreamBtn">
                    <i class="fas fa-redo"></i> Restart Stream
                </button>
            </div>
        </div>

        <!-- Real-time Logs -->
        <div class="admin-section">
            <h2><i class="fas fa-terminal"></i> System Logs</h2>
            <div class="logs-container">
                <div id="systemLogs">
                    <div class="log-entry">
                        <span class="log-time">[12:00:00]</span>
                        <span class="log-message">System initialized</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>
    <!-- Main App -->
    <script src="app.js"></script>
    
    <script>
        class AdminPanel {
            constructor() {
                this.viewerCount = 0;
                this.streamStartTime = Date.now();
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.loadVideos();
                this.startStatsUpdate();
                this.setupRealtimeListeners();
            }
            
            setupEventListeners() {
                // Add video
                document.getElementById('addVideoBtn').addEventListener('click', () => this.addVideo());
                
                // System controls
                document.getElementById('refreshBtn').addEventListener('click', () => this.loadVideos());
                document.getElementById('clearChatBtn').addEventListener('click', () => this.clearChat());
                document.getElementById('resetStreamBtn').addEventListener('click', () => this.resetStream());
                
                // Enter key for form
                document.getElementById('videoName').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.addVideo();
                });
                document.getElementById('videoUrl').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.addVideo();
                });
            }
            
            async addVideo() {
                const name = document.getElementById('videoName').value.trim();
                const url = document.getElementById('videoUrl').value.trim();
                const order = document.getElementById('videoOrder').value;
                
                if (!name || !url) {
                    this.addLog('Please fill in all required fields', 'error');
                    return;
                }
                
                try {
                    const success = await window.kinaflix.addVideo(name, url, order);
                    if (success) {
                        document.getElementById('videoName').value = '';
                        document.getElementById('videoUrl').value = '';
                        this.addLog(`Video added: ${name}`, 'success');
                    }
                } catch (error) {
                    this.addLog(`Failed to add video: ${error.message}`, 'error');
                }
            }
            
            async loadVideos() {
                await window.kinaflix.loadVideos();
                this.renderVideos();
            }
            
            renderVideos() {
                const container = document.getElementById('videosContainer');
                const videos = window.kinaflix.videos;
                
                if (videos.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-film"></i>
                            <p>No videos in playlist</p>
                            <p class="empty-sub">Add your first video above</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = videos.map((video, index) => `
                    <div class="video-item" data-id="${video.id}">
                        <div class="video-index">${index + 1}</div>
                        <div class="video-info">
                            <div class="video-title">${video.name}</div>
                            <div class="video-url">${video.url}</div>
                        </div>
                        <div class="video-actions">
                            <button class="btn btn-small" onclick="admin.playVideo('${video.id}')">
                                <i class="fas fa-play"></i>
                            </button>
                            <button class="btn btn-small btn-danger" onclick="admin.deleteVideo('${video.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
                
                // Update video count
                document.getElementById('videoCount').textContent = videos.length;
            }
            
            async deleteVideo(videoId) {
                if (!confirm('Are you sure you want to delete this video?')) return;
                
                try {
                    await window.kinaflix.deleteVideo(videoId);
                    this.addLog('Video deleted successfully', 'success');
                    this.loadVideos();
                } catch (error) {
                    this.addLog(`Failed to delete video: ${error.message}`, 'error');
                }
            }
            
            playVideo(videoId) {
                const video = window.kinaflix.videos.find(v => v.id === videoId);
                if (video) {
                    // Set as current video
                    window.kinaflix.setCurrentVideo(video);
                    this.addLog(`Now playing: ${video.name}`, 'info');
                }
            }
            
            async clearChat() {
                if (!confirm('Clear all chat messages?')) return;
                
                try {
                    // In a real app, you'd clear Firestore collection
                    this.addLog('Chat cleared', 'info');
                } catch (error) {
                    this.addLog('Failed to clear chat', 'error');
                }
            }
            
            resetStream() {
                if (!confirm('Restart stream? This will reset playback to first video.')) return;
                
                window.kinaflix.currentIndex = 0;
                if (window.player) {
                    window.player.playCurrentVideo();
                }
                this.addLog('Stream restarted', 'info');
            }
            
            startStatsUpdate() {
                // Update stream time
                setInterval(() => {
                    const uptime = Math.floor((Date.now() - this.streamStartTime) / 1000 / 60);
                    document.getElementById('streamTime').textContent = `${uptime}m`;
                }, 60000);
                
                // Update viewer count (simulated)
                setInterval(() => {
                    // In real app, get from Firestore or WebSocket
                    this.viewerCount = Math.floor(Math.random() * 100) + 50;
                    document.getElementById('viewerCount').textContent = this.viewerCount;
                }, 5000);
            }
            
            setupRealtimeListeners() {
                // Listen for video updates
                window.kinaflix.db.collection('videos').onSnapshot(() => {
                    this.loadVideos();
                });
                
                // Listen for system events
                window.addEventListener('kinaflix:videoChanged', (e) => {
                    this.addLog(`Video changed to: ${e.detail.name}`, 'info');
                });
                
                window.addEventListener('kinaflix:error', (e) => {
                    this.addLog(`Error: ${e.detail.message}`, 'error');
                });
            }
            
            addLog(message, type = 'info') {
                const logs = document.getElementById('systemLogs');
                const time = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${type}`;
                logEntry.innerHTML = `
                    <span class="log-time">[${time}]</span>
                    <span class="log-message">${message}</span>
                `;
                
                logs.appendChild(logEntry);
                logs.scrollTop = logs.scrollHeight;
                
                // Keep only last 50 logs
                const allLogs = logs.querySelectorAll('.log-entry');
                if (allLogs.length > 50) {
                    allLogs[0].remove();
                }
            }
        }
        
        // Initialize admin panel
        document.addEventListener('DOMContentLoaded', () => {
            window.admin = new AdminPanel();
        });
    </script>
</body>
</html>
